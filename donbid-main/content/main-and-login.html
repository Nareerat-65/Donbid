<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/content/main-and-login-style.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Kanit&subset=thai,latin"rel="stylesheet"type="text/css"/>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</title>
  </head>

  <body>
    <nav name="navbar" class="navbar">
      <div>
        <a href="" class="logo-link">
          <img src="../pic/Logo2.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="logo" />
        </a>
      </div>

      <div class="balance">üí∞ Coin: <span id="coinBalance">0.00</span></div>
      <button onclick="location.href='/purchaseCoins/purchaseCoins.html'">
        +
      </button>

      <div class="personal-icon">
        <a href="../content/profile-check.html" class="logo-link">
          <img
            src="../pic/personal-icon.png"
            alt="‡πÑ‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô"
            class="personal-icon"
          />
        </a>
        <span
          id="usernameDisplay"
          style="margin-left: 10px; font-weight: bold"
        ></span>
      </div>

      <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Seller -->
      <div
        id="addProductBtnContainer"
        style="text-align: right; padding: 10px; display: none"
      >
        <button
          onclick="location.href='/seller/add-product.html'"
          style="
            padding: 10px 20px;
            background-color: #FAF5E6;
            color: black;
            border: none;
            border-radius: 5px;
            cursor: pointer;
          "
        >
          + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </button>
      </div>
    </nav>
    <div class="slider">
      <div class="slides" id="slideContainer">
        <img
          src="../pic/welcome.png" alt="Placeholder Image"
        />

        <img src="../pic/DONBID.png" alt="Placeholder Image" />

        <img src="../pic/DONBID_lobo.png" alt="High Resolution Image" />
      </div>
      <div class="nav">
        <button onclick="moveSlide(-1)">‚ùÆ</button>
        <button onclick="moveSlide(1)">‚ùØ</button>
      </div>
      <div class="dots">
        <span class="dot" onclick="goToSlide(0)"></span>
        <span class="dot" onclick="goToSlide(1)"></span>
        <span class="dot" onclick="goToSlide(2)"></span>
      </div>
    </div>
    <div class="search">
      <input
        type="text"
        class="searchInput"
        id="searchInput"
        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
      />
      <button id="searchButton" class="searchButton">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <div class="product-filter">
        <button id="filterButton" class="filterButton">‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>
    </div>
    <div class="filter-block" style="display:none;">
      <div class="filter-header">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
      <button id="resetFilterBtn" class="resetFilterBtn">Reset</button>
      <div class="filter-detail">
        <div class="filter-item">
          <label for="priceRange">‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó):</label>
          <input type="number" id="minPrice" placeholder="‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î" style="width:80px;" />
          -
          <input type="number" id="maxPrice" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î" style="width:80px;" />
        </div>
        <div class="filter-item">
          <label for="auctionStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•:</label>
          <select id="auctionStatus">
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="upcoming">‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°</option>
            <option value="ongoing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•</option>
          </select>
        </div>
        <div class="filter-item">
          <label for="sortBy">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°:</label>
          <select id="sortBy">
            <option value="newest">‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
            <option value="priceLowHigh">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡πÑ‡∏õ‡∏™‡∏π‡∏á</option>
            <option value="priceHighLow">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡πÑ‡∏õ‡∏ï‡πà‡∏≥</option>
            <option value="endingSoon">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•</option>
          </select>
        </div>
        <div class="filter-item">
          <label for="cate">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <select id="cate">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="character_model">‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</option>
            <option value="doll">‡∏ï‡∏∏‡πä‡∏Å‡∏ï‡∏≤</option>
            <option value="card_game">‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏Å‡∏°</option>
            <option value="other">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
          </select>
        </div>
        <button id="applyFilterButton" class="applyFilterButton">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
      </div>
    </div>
    <div class="product-section">
      <h1>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h1>
      <a href="product.html" class="all-product">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î >></a>
    </div>
    <div class="product-list"></div>

    <!-- socket.io -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
      const socket = io();

      socket.on("connect", () => {
        console.log("‚úÖ Connected to server");
      });

      // üì¢ ‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á event ‡∏à‡∏≤‡∏Å server ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
      socket.on("product-added", (product) => {
        console.log("üì¢ New product added:", product);
        const productList = document.querySelector(".product-list");
        const newCard = createProductCard(product);
        productList.prepend(newCard);
      });

      // üÜï ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      function createProductCard(p) {
        const now = new Date();
        if (p.status === "ended") return null;

        let followed =
          JSON.parse(localStorage.getItem("followedProducts")) || [];

        const card = document.createElement("div");
        const start = new Date(p.start_time);
        const isAuctionStarted = now >= start;
        const imageGallery = p.images?.length
          ? p.images
              .map(
                (img) =>
                  `<img src="/uploads/${img}" alt="${p.name}" class="product-image">`
              )
              .join("")
          : `<img src="https://via.placeholder.com/300x150" alt="${p.name}" class="product-image">`;

        const isFollowed = followed.includes(String(p.id));

        card.className = "product-card";
        card.innerHTML = `
      <div class="images">${imageGallery}</div>
      <div class="product-info">
        <div class="product-name">${p.name}</div>
        <div class="product-price">‡∏ø${Number(p.current_price).toFixed(2)}</div>
        <div class="product-time">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        <button class="follow-btn" data-id="${p.id}"></button>
        <button class="detail-btn" style="margin-top:8px;">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        <a href="../auction_room/auction-product.html?id=${p.id}" 
           class="buy-btn ${!isAuctionStarted ? "disabled" : ""}">
           ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•
        </a>
      </div>
    `;

        // ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
        const timeElem = card.querySelector(".product-time");
        startCountdownText(p.start_time, p.end_time, timeElem);

        // ‡∏õ‡∏∏‡πà‡∏° follow
        const followBtn = card.querySelector(".follow-btn");
        updateFollowButton(followBtn, isFollowed);
        followBtn.addEventListener("click", () =>
          handleFollow(p.id, p.name, followBtn)
        );

        // ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        const detailBtn = card.querySelector(".detail-btn");
        detailBtn.addEventListener("click", () => showProductDetailPopup(p));

        return card;
      }

      let allProducts = [];

      // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      async function loadProducts() {
        try {
          const res = await fetch("/api/products");
          allProducts = await res.json();
          allProducts.sort((a, b) => new Date(a.end_time) - new Date(b.end_time));
          renderProducts(allProducts);
          startRealtimeAuctionNoti();
        } catch (err) {
          console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderProducts ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å allProducts
      function renderProducts(products) {
        const productList = document.querySelector(".product-list");
        productList.innerHTML = "";
        const now = new Date();
        let followed = JSON.parse(localStorage.getItem("followedProducts")) || [];

        

        products.forEach((p) => {
          const end = new Date(p.end_time);
          if (now >= end) return;
          const start = new Date(p.start_time);
          const isAuctionStarted = now >= start;
          const imageGallery = p.images?.length
            ? p.images
                .map(
                  (img) =>
                    `<img src="/uploads/${img}" alt="${p.name}" class="product-image">`
                )
                .join("")
            : `<img src="https://via.placeholder.com/300x150" alt="${p.name}" class="product-image">`;
          const isFollowed = followed.includes(String(p.id));
          const card = document.createElement("div");
          card.className = "product-card";
          card.innerHTML = `
        <div class="images">${imageGallery}</div>
        <div class="product-info">
          <div class="product-name">${p.name}</div>
          <div class="product-price">‡∏ø${Number(p.current_price).toFixed(2)}</div>
          <div class="product-time">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
          <button class="follow-btn" data-id="${p.id}"></button>
          <button class="detail-btn" style="margin-top:8px;">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
          <a href="../auction_room/auction-product.html?id=${p.id}" 
             class="buy-btn ${!isAuctionStarted ? "disabled" : ""}">
              ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•
          </a>
        </div>
      `;
          const timeElem = card.querySelector(".product-time");
          startCountdownText(p.start_time, p.end_time, timeElem);
          productList.appendChild(card);
          const followBtn = card.querySelector(".follow-btn");
          updateFollowButton(followBtn, isFollowed);
          followBtn.addEventListener("click", () =>
            handleFollow(p.id, p.name, followBtn)
          );
          const detailBtn = card.querySelector(".detail-btn");
          detailBtn.addEventListener("click", () => showProductDetailPopup(p));
        });
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      function searchProducts() {
        const keyword = document.getElementById("searchInput").value.toLowerCase();
        const filtered = allProducts.filter((p) =>
          p.name.toLowerCase().includes(keyword)
        );
        renderProducts(filtered);
      }
      document.getElementById("searchButton").addEventListener("click", searchProducts);
      document.getElementById("searchInput").addEventListener("input", searchProducts);
      document.getElementById("searchInput").addEventListener("keyup", (e) => e.key === "Enter" && searchProducts());

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
      document.getElementById("filterButton").addEventListener("click", (e) => {
        e.stopPropagation();
        const filterBlock = document.querySelector(".filter-block");
        filterBlock.style.display =
          filterBlock.style.display === "block" ? "none" : "block";
      });
      document.addEventListener("click", (e) => {
        const filterBlock = document.querySelector(".filter-block");
        if (
          filterBlock.style.display === "block" &&
          !filterBlock.contains(e.target) &&
          e.target !== document.getElementById("filterButton")
        ) {
          filterBlock.style.display = "none";
        }
      });

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      function applyFilters() {
        let filtered = [...allProducts];
        const now = new Date();
        const minPrice = parseFloat(document.getElementById("minPrice").value) || 0;
        const maxPrice = parseFloat(document.getElementById("maxPrice").value) || Infinity;
        filtered = filtered.filter(
          (p) => p.current_price >= minPrice && p.current_price <= maxPrice
        );
        const auctionStatus = document.getElementById("auctionStatus").value;
        filtered = filtered.filter((p) => {
          const start = new Date(p.start_time);
          const end = new Date(p.end_time);
          if (auctionStatus === "upcoming") return now < start;
          if (auctionStatus === "ongoing") return now >= start && now < end;
          return true;
        });
        const sortBy = document.getElementById("sortBy").value;
        filtered.sort((a, b) => {
          const startA = new Date(a.start_time);
          const startB = new Date(b.start_time);
          const endA = new Date(a.end_time);
          const endB = new Date(b.end_time);
          switch (sortBy) {
            case "newest":
              // ‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î = ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (start_time ‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)
              return startB - startA;
            case "priceLowHigh":
              // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡πÑ‡∏õ‡∏™‡∏π‡∏á
              return a.current_price - b.current_price;
            case "priceHighLow":
              // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡πÑ‡∏õ‡∏ï‡πà‡∏≥
              return b.current_price - a.current_price;
            case "endingSoon":
              // ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏• = end_time ‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å
              return endA - endB;
            default:
              return 0;
          }
        });
        const cate = document.getElementById("cate").value;
        if (cate) {
          filtered = filtered.filter((p) => p.category === cate);
        }
        renderProducts(filtered);
      }
      document.getElementById("applyFilterButton").addEventListener("click", applyFilters);
      document.getElementById("resetFilterBtn").addEventListener("click", () => {
        document.getElementById("minPrice").value = "";
        document.getElementById("maxPrice").value = "";
        document.getElementById("auctionStatus").value = "all";
        document.getElementById("sortBy").value = "newest";
        document.getElementById("cate").value = "";
        renderProducts(allProducts);
      });

      function showAlertError(title, message, icon = "error") {
      Swal.fire({
        icon: icon,
        title: title,
        text: message,
        confirmButtonColor: "#3085d6",
        confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
      });
    }

      function updateFollowButton(followBtn, isFollowed) {
        followBtn.textContent = isFollowed ? "‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°" : "‚≠ê ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°";
        followBtn.classList.toggle("followed", isFollowed);
      }
      function handleFollow(productId, productName, followBtn) {
        let followed =
          JSON.parse(localStorage.getItem("followedProducts")) || [];
        const isFollowed = followed.includes(String(productId));
        if (isFollowed) {
          followed = followed.filter((id) => id !== String(productId));
          updateFollowButton(followBtn, false);
          showNoti(`‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ${productName}`);
        } else {
          followed.push(String(productId));
          updateFollowButton(followBtn, true);
          showNoti(`‚≠ê ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ${productName} ‡πÅ‡∏•‡πâ‡∏ß`);
        }
        localStorage.setItem("followedProducts", JSON.stringify(followed));
      }
      function showNoti(message) {
        Swal.fire({
          text: message,
          icon: "info",
          confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
          timer: 7400,
          timerProgressBar: true,
          showClass: { popup: "swal2-show" },
          hideClass: { popup: "swal2-hide" },
        });
      }
      function startRealtimeAuctionNoti() {
        setInterval(() => {
          const followed =
            JSON.parse(localStorage.getItem("followedProducts")) || [];
          const notified =
            JSON.parse(localStorage.getItem("notifiedProducts")) || [];
          fetch("/api/products")
            .then((res) => res.json())
            .then((products) => {
              products.forEach((product) => {
                if (!followed.includes(String(product.id))) return;
                const start = new Date(product.start_time).getTime();
                const now = Date.now();
                if (now >= start && !notified.includes(String(product.id))) {
                  showNoti(`‚è∞ ‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß: ${product.name}`);
                  notified.push(String(product.id));
                  localStorage.setItem(
                    "notifiedProducts",
                    JSON.stringify(notified)
                  );
                }
              });
            });
        }, 5000);
      }
      function startCountdownText(startTimeStr, endTimeStr, element) {
        const btn = element.closest(".product-info").querySelector(".buy-btn");

        let interval;

        function update() {
          const now = new Date();
          const start = new Date(startTimeStr);
          const end = new Date(endTimeStr);

          if (status === "live" || (now >= start && now < end)) {
            const diff = Math.floor((end - now) / 1000);
            element.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•`;
            btn.classList.remove("disabled");
          } else if (now < start) {
            const diff = Math.floor((start - now) / 1000);
            element.textContent = `‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å ${formatDuration(diff)}`;
            btn.classList.add("disabled");
          } else {
            element.textContent = `‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß`;
            btn.classList.add("disabled");
            clearInterval(interval);
          }
        }

        interval = setInterval(update, 1000);
        update();
      }

      function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        if (hours > 0) {
          return `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${mins} ‡∏ô‡∏≤‡∏ó‡∏µ ${secs} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        } else if (mins > 0) {
          return `${mins} ‡∏ô‡∏≤‡∏ó‡∏µ ${secs} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        } else {
          return `${secs} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
      }

      let currentIndex = 0;
      const slides = document.getElementById("slideContainer");
      const dots = document.querySelectorAll(".dot");
      const totalSlides = slides.children.length;

      function updateSlider() {
        slides.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots.forEach((dot) => dot.classList.remove("active"));
        dots[currentIndex].classList.add("active");
      }

      function moveSlide(step) {
        currentIndex = (currentIndex + step + totalSlides) % totalSlides;
        updateSlider();
      }

      function goToSlide(index) {
        currentIndex = index;
        updateSlider();
      }

      updateSlider();

      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
      }

      window.onload = async function () {
        try {
          const token = localStorage.getItem("token");

          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ token ‚Üí redirect ‡πÑ‡∏õ login
          if (!token) {
            showAlertError("‚ùó ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
            window.location.href = "/login/login.html";
            return;
          }

          // ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î coin ‡∏à‡∏≤‡∏Å API
          const res = await fetch("/api/coins/balance", {
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î coin");
          }

          // ‡πÅ‡∏™‡∏î‡∏á coin balance ‡∏à‡∏≤‡∏Å server
          const coinSpan = document.getElementById("coinBalance");
          if (coinSpan) {
            coinSpan.textContent = Number(data.coin_balance).toFixed(2);
          }

          // ‡∏≠‡πà‡∏≤‡∏ô payload ‡∏à‡∏≤‡∏Å JWT
          const payload = parseJwt(token);

          if (payload && payload.username) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            const iconLink = document.querySelector(".personal-icon a");
            if (iconLink)
              iconLink.setAttribute("title", `‡∏Ñ‡∏∏‡∏ì ${payload.username}`);

            const nameSpan = document.getElementById("usernameDisplay");
            if (nameSpan) nameSpan.textContent = `‡∏Ñ‡∏∏‡∏ì ${payload.username}`;

            // ‡∏ñ‡πâ‡∏≤ role ‡πÄ‡∏õ‡πá‡∏ô seller ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (payload.role === "seller") {
              const addBtn = document.getElementById("addProductBtnContainer");
              if (addBtn) addBtn.style.display = "block";
            }
          } else {
            // token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚Üí ‡∏•‡∏ö token ‡πÅ‡∏•‡∏∞ redirect
            showAlertError("‚ùó ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            localStorage.removeItem("token");
            window.location.href = "/login/login.html";
            return;
          }

          // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ
          loadProducts();
          startRealtimeAuctionNoti();
        } catch (err) {
          console.error("Error on window.onload:", err);
          showAlertError("‚ùó ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
          // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ error ‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á ‡∏≠‡∏≤‡∏à redirect ‡πÑ‡∏õ login
          // window.location.href = '/login/login.html';
        }
      };

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á popup ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      async function showProductDetailPopup(product) {
        let sellerName = product.seller_username || "-";
        if (!product.seller_username) {
          try {
            const res = await fetch(`/api/products/${product.id}`);
            const detail = await res.json();
            sellerName = detail.seller_username || "-";
          } catch (err) {
            sellerName = "-";
          }
        }

        const images = product.images?.length
          ? product.images.map(
              (img, idx) =>
                `<img src="/uploads/${img}" alt="${product.name}" 
                  class="popup-image" 
                  style="width:100%;height:480px;object-fit:contain;
                        border-radius:8px;background:#fff;
                        display:${idx === 0 ? "block" : "none"};">`
            )
          : [`<img src="https://via.placeholder.com/900x480" 
              class="popup-image" 
              style="width:100%;height:480px;object-fit:contain;
                      border-radius:8px;background:#fff;display:block;">`];

        const thumbnails = product.images?.length
          ? product.images
              .map(
                (img, idx) =>
                  `<img src="/uploads/${img}" 
                    class="popup-thumb ${idx === 0 ? "selected" : ""}" 
                    style="width:80px;height:80px;object-fit:cover;border-radius:6px;
                          border:2px solid ${idx === 0 ? "#ff4d4d" : "#ddd"};
                          cursor:pointer;margin:4px;">`
              )
              .join("")
          : "";

        const html = `
        <div style="display:flex;flex-wrap:wrap;gap:24px;align-items:flex-start;max-width:1000px;margin:auto;font-family:'Kanit',sans-serif;">
          <div style="flex:1 1 48%;text-align:center;">
            <div class="popup-image-container" style="position:relative;">
              ${images.join("")}
            </div>
            <div style="display:flex;justify-content:center;flex-wrap:wrap;margin-top:12px;">${thumbnails}</div>
          </div>

          <div style="flex:1 1 48%;text-align:left;margin-left:15px;">
            <h2 style="font-size:40px;font-weight:700;margin-bottom:8px;">${product.name}</h2>
            <p style="color:#777;font-size:16px;margin:6px 0;">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${product.id}</p>
            <p style="font-size:30px;font-weight:700;color:#d32f2f;">‡∏ø${Number(product.current_price).toFixed(2)}</p>
            ${
              product.original_price
                ? `<p style="text-decoration:line-through;color:#888;">‡∏ø${Number(product.original_price).toFixed(2)}</p>`
                : ""
            }
            <p style="margin-top:12px;"><b>‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢:</b> ${sellerName}</p>
            <p><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</b> ${product.category || "-"}</p>
            <p style="line-height:1.6;"><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</b>${product.description || "-"}</p>

            <div style="margin-top:20px;">
              <button id="bidBtn" style="
                background-color:#ff9900;color:#fff;
                font-size:1.1rem;padding:12px 28px;
                border:none;border-radius:8px;
                cursor:pointer;transition:0.2s;">
                ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•
              </button>
            </div>
          </div>
        </div>`;

        Swal.fire({
          html: html,
          showConfirmButton: false,
          width: "60vw",
          customClass: { popup: "wide-popup" },
          didOpen: () => {
            const thumbs = Swal.getHtmlContainer().querySelectorAll(".popup-thumb");
            const imgs = Swal.getHtmlContainer().querySelectorAll(".popup-image");

            // üß© ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏π‡∏õ
            thumbs.forEach((thumb, idx) => {
              thumb.addEventListener("click", () => {
                imgs.forEach((img, i) => {
                  img.style.display = i === idx ? "block" : "none";
                });
                thumbs.forEach((t, j) => {
                  t.style.borderColor = j === idx ? "#ff4d4d" : "#ddd";
                });
              });
            });

            const bidBtn = Swal.getHtmlContainer().querySelector("#bidBtn");
            const now = new Date();
            const start = new Date(product.start_time);
            const end = new Date(product.end_time);
            const isAuctionStarted = now >= start && now < end;

            if (!isAuctionStarted) {
              bidBtn.disabled = true;
              bidBtn.style.opacity = "0.6";
              bidBtn.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•";
            } else {
              bidBtn.onclick = () =>
                (window.location.href = `../auction_room/auction-product.html?id=${product.id}`);
            }
          },
        });
      }


    </script>
  </body>
</html>

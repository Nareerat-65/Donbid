<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/content/main-and-login-style.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Kanit&subset=thai,latin"
      rel="stylesheet"
      type="text/css"
    />
    <title>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</title>
  </head>

  <body>
    <nav name="navbar" class="navbar">
      <div>
        <a href="" class="logo-link">
          <img src="../pic/Logo.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="logo" />
        </a>
      </div>

      <div class="balance">üí∞ Coin: <span id="coinBalance">0.00</span></div>
      <button onclick="location.href='/purchaseCoins/purchaseCoins.html'">
        +
      </button>

      <div class="personal-icon">
        <a href="../content/profile-check.html" class="logo-link">
          <img
            src="../pic/personal-icon.png"
            alt="‡πÑ‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô"
            class="personal-icon"
          />
        </a>
        <span
          id="usernameDisplay"
          style="margin-left: 10px; font-weight: bold"
        ></span>
      </div>

      <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Seller -->
      <div
        id="addProductBtnContainer"
        style="text-align: right; padding: 10px; display: none"
      >
        <button
          onclick="location.href='/seller/add-product.html'"
          style="
            padding: 10px 20px;
            background-color: #ff9900;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
          "
        >
          + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </button>
      </div>
    </nav>
    <div class="slider">
      <div class="slides" id="slideContainer">
        <img
          src="https://placehold.co/1000x400/transparent/F00.png?text=Sample+Text"
          alt="Transparent Image"
        />

        <img src="../pic/img3.jpg" alt="Placeholder Image" />

        <img src="../pic/img2.jpg" alt="High Resolution Image" />
      </div>
      <div class="nav">
        <button onclick="moveSlide(-1)">‚ùÆ</button>
        <button onclick="moveSlide(1)">‚ùØ</button>
      </div>
      <div class="dots">
        <span class="dot" onclick="goToSlide(0)"></span>
        <span class="dot" onclick="goToSlide(1)"></span>
        <span class="dot" onclick="goToSlide(2)"></span>
      </div>
    </div>
    <div class="product-section">
      <h1>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h1>
      <a href="product.html" class="all-product">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î >></a>
    </div>
    <div class="product-list"></div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      async function loadProducts() {
        try {
          const res = await fetch("/api/products");
          const products = await res.json();
          const productList = document.querySelector(".product-list");
          productList.innerHTML = "";
          let followed = JSON.parse(localStorage.getItem("followedProducts")) || [];
          products.forEach((p) => {
            const now = new Date();
            if (p.status === "ended") return;
            const card = document.createElement("div");
            const start = new Date(p.start_time);
            const isAuctionStarted = now >= start;
            const imageGallery = p.images?.length
              ? p.images.map((img) => `<img src="/uploads/${img}" alt="${p.name}" class="product-image">`).join("")
              : `<img src="https://via.placeholder.com/300x150" alt="${p.name}" class="product-image">`;
            const isFollowed = followed.includes(String(p.id));
            card.className = "product-card";
            card.innerHTML = `
              <div class="images">${imageGallery}</div>
              <div class="product-info">
                <div class="product-name">${p.name}</div>
                <div class="product-price">‡∏ø${Number(p.current_price).toFixed(2)}</div>
                <div class="product-time">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                <button class="follow-btn" data-id="${p.id}"></button>
                <a href="../auction_room/auction-product.html?id=${p.id}" class="buy-btn ${!isAuctionStarted ? "disabled" : ""}">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•</a>
              </div>
            `;
            const timeElem = card.querySelector(".product-time");
            startCountdownText(p.start_time, p.end_time, timeElem);
            productList.appendChild(card);
            const followBtn = card.querySelector(".follow-btn");
            updateFollowButton(followBtn, isFollowed);
            followBtn.addEventListener("click", () => handleFollow(p.id, p.name, followBtn));
          });
        } catch (err) {
          console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
        }
      }
      function updateFollowButton(followBtn, isFollowed) {
        followBtn.textContent = isFollowed ? "‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°" : "‚≠ê ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°";
        followBtn.classList.toggle("followed", isFollowed);
      }
      function handleFollow(productId, productName, followBtn) {
        let followed = JSON.parse(localStorage.getItem("followedProducts")) || [];
        const isFollowed = followed.includes(String(productId));
        if (isFollowed) {
          followed = followed.filter((id) => id !== String(productId));
          updateFollowButton(followBtn, false);
          showNoti(`‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ${productName}`);
        } else {
          followed.push(String(productId));
          updateFollowButton(followBtn, true);
          showNoti(`‚≠ê ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ${productName} ‡πÅ‡∏•‡πâ‡∏ß`);
        }
        localStorage.setItem("followedProducts", JSON.stringify(followed));
      }
      function showNoti(message) {
        Swal.fire({
          text: message,
          icon: "info",
          confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
          timer: 7400,
          timerProgressBar: true,
          showClass: { popup: "swal2-show" },
          hideClass: { popup: "swal2-hide" },
        });
      }
      function startRealtimeAuctionNoti() {
        setInterval(() => {
          const followed = JSON.parse(localStorage.getItem("followedProducts")) || [];
          const notified = JSON.parse(localStorage.getItem("notifiedProducts")) || [];
          fetch("/api/products")
            .then((res) => res.json())
            .then((products) => {
              products.forEach((product) => {
                if (!followed.includes(String(product.id))) return;
                const start = new Date(product.start_time).getTime();
                const now = Date.now();
                if (now >= start && !notified.includes(String(product.id))) {
                  showNoti(`‚è∞ ‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß: ${product.name}`);
                  notified.push(String(product.id));
                  localStorage.setItem("notifiedProducts", JSON.stringify(notified));
                }
              });
            });
        }, 5000);
      }
      function startCountdownText(startTimeStr, endTimeStr, element) {
        const btn = element.closest(".product-info").querySelector(".buy-btn");

        let interval;

        function update() {
          const now = new Date();
          const start = new Date(startTimeStr);
          const end = new Date(endTimeStr);

          if (status === "live" || (now >= start && now < end)) {
            const diff = Math.floor((end - now) / 1000);
            element.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•`;
            btn.classList.remove("disabled");
          } else if (now < start) {
            const diff = Math.floor((start - now) / 1000);
            element.textContent = `‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å ${formatDuration(diff)}`;
            btn.classList.add("disabled");
          } else {
            element.textContent = `‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß`;
            btn.classList.add("disabled");
            clearInterval(interval);
          }
        }

        interval = setInterval(update, 1000);
        update();
      }

      function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        if (hours > 0) {
          return `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${mins} ‡∏ô‡∏≤‡∏ó‡∏µ ${secs} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        } else if (mins > 0) {
          return `${mins} ‡∏ô‡∏≤‡∏ó‡∏µ ${secs} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        } else {
          return `${secs} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
      }

      let currentIndex = 0;
      const slides = document.getElementById("slideContainer");
      const dots = document.querySelectorAll(".dot");
      const totalSlides = slides.children.length;

      function updateSlider() {
        slides.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots.forEach((dot) => dot.classList.remove("active"));
        dots[currentIndex].classList.add("active");
      }

      function moveSlide(step) {
        currentIndex = (currentIndex + step + totalSlides) % totalSlides;
        updateSlider();
      }

      function goToSlide(index) {
        currentIndex = index;
        updateSlider();
      }

      updateSlider();

      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
      }

      window.onload = async function () {
        try {
          const token = localStorage.getItem("token");

          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ token ‚Üí redirect ‡πÑ‡∏õ login
          if (!token) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
            window.location.href = "/login/login.html";
            return;
          }

          // ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î coin ‡∏à‡∏≤‡∏Å API
          const res = await fetch("/api/coins/balance", {
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î coin");
          }

          // ‡πÅ‡∏™‡∏î‡∏á coin balance ‡∏à‡∏≤‡∏Å server
          const coinSpan = document.getElementById("coinBalance");
          if (coinSpan) {
            coinSpan.textContent = Number(data.coin_balance).toFixed(2);
          }

          // ‡∏≠‡πà‡∏≤‡∏ô payload ‡∏à‡∏≤‡∏Å JWT
          const payload = parseJwt(token);

          if (payload && payload.username) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            const iconLink = document.querySelector(".personal-icon a");
            if (iconLink)
              iconLink.setAttribute("title", `‡∏Ñ‡∏∏‡∏ì ${payload.username}`);

            const nameSpan = document.getElementById("usernameDisplay");
            if (nameSpan) nameSpan.textContent = `‡∏Ñ‡∏∏‡∏ì ${payload.username}`;

            // ‡∏ñ‡πâ‡∏≤ role ‡πÄ‡∏õ‡πá‡∏ô seller ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (payload.role === "seller") {
              const addBtn = document.getElementById("addProductBtnContainer");
              if (addBtn) addBtn.style.display = "block";
            }
          } else {
            // token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚Üí ‡∏•‡∏ö token ‡πÅ‡∏•‡∏∞ redirect
            alert("Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            localStorage.removeItem("token");
            window.location.href = "/login/login.html";
            return;
          }

          // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ
          loadProducts();
          startRealtimeAuctionNoti();
        } catch (err) {
          console.error("Error on window.onload:", err);
          alert(err.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
          // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ error ‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á ‡∏≠‡∏≤‡∏à redirect ‡πÑ‡∏õ login
          // window.location.href = '/login/login.html';
        }
      };
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href='https://fonts.googleapis.com/css?family=Kanit&subset=thai,latin' rel='stylesheet' type='text/css'>
  <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</title>

  <style>
    body {
      margin: 0;
      font-family: 'Kanit', sans-serif;
      background-color: #f4f4f4;
    }

    .header {
      background-color: #FAF5E6;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 32px;
      border-bottom: 1px solid #ddd;
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #009688;
    }

    .balance {
      font-size: 18px;
      color: #333;
    }

    .main {
      width: 90%;
      max-width: 1500px;
      display: flex;
      gap: 20px;
      padding: 20px;
      align-items: center;
      margin: 40px auto 0 auto;
    }

    .sidebar {
      width: 200px;
      background: #f2f2f2;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-radius: 10px;
      height: fit-content;
      align-self: flex-start;
      margin-top: 2%;
      /* ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
    }

    .hamburger {
      display: none;
      /* Desktop ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå */
    }

    .sidebar button {
      padding: 12px;
      background: #ffa500;
      color: rgb(255, 255, 255);
      border: none;
      cursor: pointer;
      border-radius: 5px;
      font-size: 16px;
    }

    .sidebar button:hover {
      background: #ffcf76;
    }

    .content-area {
      flex: 1;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: stretch;

      width: 100%;
    }

    .content-area h2 {
      text-align: center;
      margin-bottom: 16px;
      /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
    }

    .profile-container {
      max-width: 500px;
      margin: 0 auto;
      border-radius: 20px;
      padding: 32px 24px;
      text-align: center;
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffeec7 60%, #ccc 100%);
      margin: auto;
      border: 4px solid #fffbe6;
    }

    .profile-name {
      margin-top: 16px;
      font-size: 22px;
      font-weight: bold;
      color: #009688;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 32px;
    }

    .profile-box {
      padding: 16px;
      background: #f9f9f9;
      border-radius: 8px;
      font-size: 16px;
      color: #333;
    }

    /* ---------- ‡∏õ‡∏∏‡πà‡∏° ---------- */
    #logout-btn,
    #change-role {
      margin-top: 20px;
      padding: 12px 24px;
      background: linear-gradient(90deg, #ffa500 60%, #ff6f00 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
    }

    #logout-btn:hover {
      background: linear-gradient(90deg, #e53935 60%, #c62828 100%);
    }

    #change-role:hover {
      background: linear-gradient(90deg, #009688 60%, #26a69a 100%);
    }

    .product-card {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      /* ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î */
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 12px;
      margin: 12px auto;
      margin-bottom: 12px;
      background-color: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      width: 80%;
      /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏° parent */
      max-width: 800px;
    }

    .product-img {
      width: 200px;
      height: 210px;
      object-fit: cover;
      border-radius: 6px;
      flex-shrink: 0;
      /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏π‡∏õ‡∏¢‡πà‡∏≠‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
    }

    .product-details {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .product-details h3 {
      margin: 0 0 6px 0;
      font-size: 1.2em;
    }

    .product-details p {
      margin: 4px 0;
    }

    .product-details small {
      color: #666;
    }

    /* ---------- Responsive ---------- */
    @media (max-width: 768px) {
      .main {
        flex-direction: column;
        align-items: center;
      }

      .hamburger {
        display: block;
        /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏° */
        background: #009688;
        color: white;
        border: none;
        padding: 12px 16px;
        font-size: 18px;
        cursor: pointer;
        border-radius: 5px;
        margin: 10px 0;
        width: 100%;
      }

      .sidebar {
        display: none;
        /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô */
        width: 100%;
        flex-direction: column;
        gap: 5px;
        margin-bottom: 15px;
      }

      .sidebar.active {
        display: flex;
        /* ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° */
      }

      .profile-container {
        max-width: 95vw;
      }

      .profile-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      #logout-btn,
      #change-role {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <div>
      <a href="../content/main-and-login.html" class="logo-link">
        <img src="../pic/Logo.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="logo" width="150" height="150">
      </a>
    </div>
  </div>

  <div class="main">
    <button class="hamburger" id="hamburgerBtn">‚ò∞ ‡πÄ‡∏°‡∏ô‡∏π</button>

    <div class="sidebar" id="sidebarMenu">
      <div class="balance">üí∞ Coin: <span id="balance">0.00</span>
        <button onclick="location.href='/purchaseCoins/purchaseCoins.html'">
          +
        </button>
      </div>
      <button data-page="profile">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
      <button data-page="myProducts">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
      <button data-page="myProductSell">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</button>

    </div>

    <div class="content-area" id="contentArea">
      <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏î -->
    </div>

  </div>

  <script>
    function renderProfile(payload) {
      const content = document.getElementById("contentArea");
      content.innerHTML = `
        <div class="profile-container">
          <div class="profile-avatar"></div>
          <div class="profile-name" id="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
          <div class="profile-grid">
            <div class="profile-box">ID: <span id="userId">-</span></div>
            <div class="profile-box">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: <span id="role">-</span></div>
            <div class="profile-box">Email: <span id="email">-</span></div>
            <div class="profile-box">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="status">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span></div>
          </div>

          <button id="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          <button id="change-role">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</button>
        </div>
      `;

      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
      document.getElementById('username').textContent = payload.username || '-';
      document.getElementById('userId').textContent = payload.id || '-';
      document.getElementById('role').textContent = payload.role || '-';
      document.getElementById('email').textContent = payload.email || '-';

      // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
      const avatarDiv = document.querySelector('.profile-avatar');
      avatarDiv.innerHTML = '';
      let profileImgUrl = '../pic/personal-icon.png';
      if (payload && payload.profile_img) {
        profileImgUrl = payload.profile_img;
      }
      const img = document.createElement('img');
      img.src = profileImgUrl;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '50%';
      avatarDiv.appendChild(img);

      // ‡∏õ‡∏∏‡πà‡∏° logout
      document.getElementById('logout-btn').onclick = () => {
        localStorage.removeItem('token');
        window.location.href = '/login/login.html';
      };

      // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô role
      const changeRoleBtn = document.getElementById('change-role');
      if (payload.role === 'seller') {
        changeRoleBtn.style.display = 'none';
      }
      changeRoleBtn.onclick = async () => {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/auth/user/upgrade-role', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const result = await res.json();
        if (res.ok && result.token) {
          localStorage.setItem('token', result.token);
          alert(result.message);
          location.reload();
        } else {
          alert(result.error || result.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      };
    }

    // parse jwt
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return null;
      }
    }

    window.onload = async () => {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
        window.location.href = '/login/login.html';
        return;
      }

      const payload = parseJwt(token);
      if (!payload) {
        alert('Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        localStorage.removeItem('token');
        window.location.href = '/login/login.html';
        return;
      }

      // ‡πÇ‡∏´‡∏•‡∏î coin
      try {
        const res = await fetch('/api/coins/balance', {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        if (res.ok && data.coin_balance !== undefined) {
          document.getElementById('balance').textContent = Number(data.coin_balance).toFixed(2);
        }
      } catch (err) { }

      // ‡πÇ‡∏´‡∏•‡∏î profile ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      renderProfile(payload);
    };

    // sidebar click
    document.getElementById("sidebarMenu").addEventListener("click", (e) => {
      if (e.target.tagName === "BUTTON") {
        const page = e.target.dataset.page;
        const payload = parseJwt(localStorage.getItem('token'));

        if (page === "profile") {
          renderProfile(payload);  // ‚úÖ ‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        }
        if (page === "myProducts") {
          document.getElementById("contentArea").innerHTML = `<h2>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏ä‡∏ô‡∏∞</h2><div id="myProductsList">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;

          const token = localStorage.getItem('token');
          fetch('/api/profile', {
            headers: { 'Authorization': 'Bearer ' + token }
          })
            .then(res => res.json())
            .then(products => {
              const list = document.getElementById("myProductsList");
              if (!products.length) {
                list.innerHTML = "<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞</p>";
                return;
              }
              list.innerHTML = products.map(p => `
              <div class="product-card">
                <img src="${p.images[0] || '../pic/default.png'}" class="product-img"/>
                <div class="product-details">
                  <h3>${p.name}</h3>
                  <p>${p.description || ''}</p>
                  <p>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ${p.final_price} coins</p>
                  <small>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•: ${new Date(p.closed_at).toLocaleString()}</small>
                </div>
              </div>
            `).join('');
            })
            .catch(err => {
              console.error(err);
              document.getElementById("myProductsList").innerHTML = "<p>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>";
            });
        }if (page === "myProductSell") {
          document.getElementById("contentArea").innerHTML = `<h2>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏Ç‡∏≤‡∏¢</h2><div id="myProductSellList">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;

          const token = localStorage.getItem('token');
          fetch('/api/profile/selling', {
            headers: { 'Authorization': 'Bearer ' + token }
          })
            .then(res => res.json())
            .then(products => {
              const list = document.getElementById("myProductSellList");
              if (!products.length) {
                list.innerHTML = "<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏≤‡∏¢</p>";
                return;
              }
              list.innerHTML = products.map(p => `
              <div class="product-card">
                <img src="${p.images[0] || '../pic/default.png'}" class="product-img"/>
                <div class="product-details">
                  <h3>${p.name}</h3>
                  <p>${p.description || ''}</p>
                  <p>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${p.current_price} coins</p>
                  <small>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•: ${new Date(p.closed_at).toLocaleString()}</small>
                </div>
              </div>
            `).join('');
            })
            .catch(err => {
              console.error(err);
              document.getElementById("myProductSellList").innerHTML = "<p>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>";
            });
        }

        document.getElementById("sidebarMenu").classList.remove("active");
      }
    });
  </script>

</body>

</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="auction-product-style.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Kanit&subset=thai,latin"
      rel="stylesheet"
      type="text/css"
    />
    <title>‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•</title>
  </head>

  <body>
    <nav name="navbar" class="navbar">
      <div>
        <a href="../content/main-and-login.html" class="logo-link">
          <img src="../pic/Logo.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="logo" />
        </a>
      </div>

      <div class="balance">üí∞ Coin: <span id="coinBalance">0.00</span></div>
      <button onclick="location.href='/purchaseCoins/purchaseCoins.html'">
        +
      </button>

      <div class="personal-icon">
        <a href="../content/profile-check.html" class="logo-link">
          <img
            src="../pic/personal-icon.png"
            alt="‡πÑ‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô"
            class="personal-icon"
          />
        </a>
        <span
          id="usernameDisplay"
          style="margin-left: 10px; font-weight: bold"
        ></span>
      </div>

      <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Seller -->
      <div
        id="addProductBtnContainer"
        style="text-align: right; padding: 10px; display: none"
      >
        <button
          onclick="location.href='/seller/add-product.html'"
          style="
            padding: 10px 20px;
            background-color: #ff9900;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
          "
        >
          + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </button>
      </div>
    </nav>

    <div class="auction-container">
      <div class="auction-content">
        <!-- ‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
        <div class="media-carousel">
          <button class="arrow left">‚ùÆ</button>
          <div class="media-display">
            <div id="productImages"></div>
          </div>
          <button class="arrow right">‚ùØ</button>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏• -->
        <div class="auction">
          <div class="AI-box">
            <div class="model-AI">
              <img id="modelFace" src="pic/mouth1.jpg" width="200">
            </div>
            <div class="timer">
              <p><span id="productTimeRemaining">-- : -- : --</span></p>
            </div>

            <!-- ‚úÖ ‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° AI -->
            <div class="ai-message-container">
              <div id="ai-message">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° AI ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
              </div>
            </div>
          </div>

          <button id="openHistoryBtn" class="btn-history">
            ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
          </button>
          <!-- MODAL -->
          <div id="bidHistoryModal" class="modal">
            <div class="modal-content">
              <span class="close">&times;</span>
              <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h3>
              <ul id="bidHistoryList" style="list-style: none; padding: 0"></ul>
            </div>
          </div>

          <div class="bid-section">
            <div class="custom-bid">
              <label>‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</label>
              <input
                type="number"
                class="bid"
                id="customBid"
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠"
              />
              <button id="customBidBtn" class="btn-bid">‡πÄ‡∏™‡∏ô‡∏≠</button>
            </div>

            <div class="quick-bid">
              <span>‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>
              <button class="btn-bid">-</button>
              <button class="btn-bid">-</button>
              <button class="btn-bid">-</button>
            </div>
          </div>
        </div>
      </div>

      <div class="participant-count">
          ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° <span class="count">0</span> ‡∏Ñ‡∏ô
          <span class="avatars"></span>
      </div>


      <div class="product-details">
        <h1 id="productName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
        <h1 id="highestBid">‡∏ø0.00</h1>
        <p id="productPrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        <p id="productCategory">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        <p>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î : <span id="productDescription">-</span></p>
        <p id="productSeller">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        <p id="productStartTime">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        <p id="productEndTime">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
      </div>
    </div>

    <audio id="ttsAudio"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // ====== Socket.IO Real-time Auction ======
      const socket = io();

      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ bid ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å server ‡πÉ‡∏´‡πâ update UI
      socket.on("new bid", function (data) {
        if (data.productId === productId) {
          document.getElementById(
            "highestBid"
          ).textContent = `‡∏ø${data.bidAmount}`;
          loadBidHistory(productId);
          updateQuickBidButtons(productId);
          // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡πà‡∏≤‡∏ô AI (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ username)
          if (data.username) announceBidAI(data.username, data.bidAmount);

          resetIdleTimer(productId, { 
            name: document.getElementById("productName").textContent,
            description: document.getElementById("productDescription").textContent,
            start_price: parseFloat(document.getElementById("productPrice").textContent.replace(/\D/g,'')) 
          });
              
        }
      });
        const params = new URLSearchParams(window.location.search);
        const productId = params.get("id");

      async function loadProductDetails() {
        try {
          const res = await fetch(`/api/products/${productId}`);
          let product = await res.json();

          if (Array.isArray(product)) {
            product = product.length > 0 ? product[0] : null;
          }

          if (!product) {
            console.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
            return;
          }
          const imagesContainer = document.getElementById("productImages");

          // render gallery
          const imageGallery = product.images?.length
            ? product.images
                .map(
                  (img) =>
                    `<img src="/uploads/${img}" alt="${product.name}" class="product-image">`
                )
                .join("")
            : `<img src="https://via.placeholder.com/300x150" alt="${product.name}" class="product-image">`;

          // set innerHTML
          imagesContainer.innerHTML = imageGallery;
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          console.log(product);
          document.getElementById("productName").textContent = product.name;
          document.getElementById("productPrice").textContent = `‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô : ${product.start_price}`;
          document.getElementById("productCategory").textContent = `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${product.category || "-"}`;
          document.getElementById("productDescription").textContent = product.description || "-";
          document.getElementById("productSeller").textContent = `‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢: ${product.seller_username}`;
          document.getElementById("productStartTime").textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ${new Date(product.start_time).toLocaleString()}`;
          document.getElementById("productEndTime").textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ${new Date(product.end_time).toLocaleString()}`;
    
          // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
          const timeElem = document.getElementById("productTimeRemaining");
          if (product.status === "live") {
            welcomeAI(product);
            resetIdleTimer(productId, product);
          }
          startCountdown(product.end_time, timeElem);
        } catch (err) {
          console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err);
        }
      }

      async function loadHighestBid(productId) {
        try {
          const res = await fetch(`/api/bids/highest?product_id=${productId}`);
          const data = await res.json();
          document.getElementById(
            "highestBid"
          ).textContent = `‡∏ø${data.highest}`;
        } catch (err) {
          console.error("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", err);
        }
      }

      function splitThaiText(text, maxLength = 50) {
        // üî• ‡∏•‡∏ö \n ‡πÅ‡∏•‡∏∞ space ‡∏ã‡πâ‡∏≥
        text = text.replace(/\s+/g, " ").trim();

        let sentences = text.split(/(?<=[‡πÜ,.!?‚Ä¶])/);
        let chunks = [];
        let buffer = "";

        for (let s of sentences) {
          if ((buffer + s).length > maxLength) {
            if (buffer.trim()) chunks.push(buffer.trim());
            buffer = s;
          } else {
            buffer += s;
          }
        }
        if (buffer.trim()) chunks.push(buffer.trim());

        return chunks;
      }

      async function playTTS(text) {
        console.log("üé§ [TTS INPUT]", text);
        const audioElem = document.getElementById("ttsAudio");

        const chunks = splitThaiText(text, 50);
        console.log("üé§ Chunks:", chunks);

        const audioUrls = await Promise.all(
          chunks
            .filter(chunk => chunk.trim() !== "") // ‡∏Å‡∏±‡∏ô empty
            .map(async (chunk) => {
              const res = await fetch("/api/ai/tts", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: chunk }),
              });
              if (!res.ok) {
                const errText = await res.text();
                console.error("‚ùå TTS API Error:", errText);
                throw new Error("TTS API error");
              }

              const arrayBuffer = await res.arrayBuffer();
              const blob = new Blob([arrayBuffer], { type: "audio/mpeg" });
              return URL.createObjectURL(blob);
            })
        );

        let index = 0;
        function playNext() {
          if (index >= audioUrls.length) return;
          audioElem.src = audioUrls[index++];
          audioElem.play().catch((err) => {
            console.warn("Autoplay blocked:", err);
          });
        }

        audioElem.onended = playNext;
        playNext();
      }

      // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° AI
      function showAIMessage(msg) {
        const container = document.getElementById("ai-message");
        const bubble = document.createElement("div");
        bubble.classList.add("ai-bubble");
        bubble.textContent = msg;
        container.appendChild(bubble);

        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        container.scrollTop = container.scrollHeight;
      }

      async function loadAuctionLogs(productId) {
        try {
          const res = await fetch(`/api/ai/${productId}/logs`);
          const logs = await res.json();

          logs.forEach((log) => {
            showAIMessage(log.message);
          });
        } catch (err) {
          console.error("‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err);
        }
      }

      function fetchAIMessage(prompt, fallbackMsg, productId, type = null) {
        fetch("/api/ai/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: prompt,
            product_id: productId,
            type,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            const msg = data.reply || fallbackMsg;
            showAIMessage(msg);
            playTTS(msg);
          })
          .catch((err) => {
            console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI:", err);
            showAIMessage(fallbackMsg);
          });
      }

      // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° AI ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
      window.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get("id");

            // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏Å‡πà‡∏≤
            if (productId) {
                loadAuctionLogs(productId);
            }
      });

      let hasWelcomed = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥

      async function welcomeAI(product) {
        if (hasWelcomed) return; // ‡∏Å‡∏±‡∏ô‡∏û‡∏π‡∏î‡∏ã‡πâ‡∏≥
        hasWelcomed = true;

        const prompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏• ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á AI ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©:\n
        ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${product.name}\n
        ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${product.description}\n
        ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ${product.start_price} ‡∏ö‡∏≤‡∏ó`;

        fetchAIMessage(prompt, "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•!", product.id, "welcome");
      }

      let idleTimer;
      const idleTimeLimit = 30000; // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

      function resetIdleTimer(productId, product) {
        if (idleTimer) clearTimeout(idleTimer);
        idleTimer = setTimeout(() => triggerIdleAI(productId, product), idleTimeLimit);
      }

      async function triggerIdleAI(productId, product) {

        if (auctionEnded) return;
        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±
        const resBid = await fetch(`/api/bids/highest?product_id=${productId}`);
        const highestBid = await resBid.json();

        const prompt =
          "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á AI ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©:\n" +
          `‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${product.name}\n` +
          `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${product.description}\n` +
          `‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ${product.start_price} ‡∏ö‡∏≤‡∏ó\n` +
          `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${highestBid.highest || product.start_price} ‡∏ö‡∏≤‡∏ó`;

        fetchAIMessage(prompt, "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏±‡∏á‡πÄ‡∏• ‡∏°‡∏≤‡∏•‡∏≠‡∏á‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢!", productId);

        // üîÅ ‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
        resetIdleTimer(productId, product);
        
      }

      // ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ AI ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
      async function announceBidAI(username, amount) {
        const prompt = `‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å ${username} ‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${amount} ‡∏ö‡∏≤‡∏ó ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡πÅ‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©`;
        fetchAIMessage(prompt,`‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ ${username} ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${amount} ‡∏ö‡∏≤‡∏ó!`,productId,"bid");
      }

      document.getElementById("customBidBtn").addEventListener("click", async () => {
          const token = localStorage.getItem("token");
          if (!token) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
            return;
          }

          const bidInput = document.querySelector(".custom-bid input");
          const bidAmount = parseFloat(bidInput.value);
          if (isNaN(bidAmount) || bidAmount <= 0) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            return;
          }

          try {
            const res = await fetch("/api/bids", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                product_id: productId,
                bid_price: bidAmount,
              }),
            });

            const data = await res.json();
            if (res.ok) {
              alert("‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
              // ‡∏™‡πà‡∏á event ‡πÑ‡∏õ server ‡πÄ‡∏û‡∏∑‡πà‡∏≠ broadcast ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å client
              const payload = parseJwt(token);
              socket.emit("bid placed", {
                productId,
                bidAmount,
                username:
                  payload && payload.username ? payload.username : undefined,
              });
            } else {
              alert(data.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤");
            }
          } catch (err) {
            console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤:", err);
            alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á");
          }
        });

      async function updateQuickBidButtons(productId) {
        try {
          const res = await fetch(`/api/bids/highest?product_id=${productId}`);
          const data = await res.json();

          const currentPrice =
            data.highest ||
            parseFloat(
              document
                .getElementById("productPrice")
                .textContent.replace("‡∏ø", "")
            );

          const quickButtons = document.querySelectorAll(".quick-bid .btn-bid");
          const percents = [10, 20, 30]; // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏ô‡∏ï‡πå‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

          quickButtons.forEach((btn, index) => {
            const percent = percents[index];
            const bid = Math.ceil(currentPrice * (1 + percent / 100));
            btn.textContent = bid;
            btn.dataset.bid = bid;
          });
        } catch (err) {
          console.error("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° Quick Bid ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", err);
        }
      }

      // ‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î modal
      document.getElementById("openHistoryBtn").addEventListener("click", () => {
          document.getElementById("bidHistoryModal").style.display = "block";
          loadBidHistory(productId); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î
        });
      document.querySelector(".modal .close").addEventListener("click", () => {
        document.getElementById("bidHistoryModal").style.display = "none";
      });
      window.addEventListener("click", (e) => {
        const modal = document.getElementById("bidHistoryModal");
        if (e.target === modal) modal.style.display = "none";
      });

      async function loadBidHistory(productId) {
        try {
          const res = await fetch(`/api/bids/history?product_id=${productId}`);
          const data = await res.json();

          const list = document.getElementById("bidHistoryList");
          list.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô

          data.forEach((bid) => {
            const li = document.createElement("li");
            li.style.marginBottom = "5px";
            li.textContent = `${bid.username} ‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ø${
              bid.bid_price
            } ‡πÄ‡∏ß‡∏•‡∏≤ ${formatDate(bid.created_at)}`;
            list.appendChild(li);
          });
        } catch (err) {
          console.error("‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err);
        }
      }

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(
          date.getDate()
        )} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
      }

      let auctionEnded = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡∏à‡∏ö
      function startCountdown(endTimeStr, element) {
        let called = false;
        let interval;
        let countdownActive = false;

            // üö® Soft Close Countdown
        async function updateCountdown(seconds, ExtendTime = false) {
          let timeLeft = seconds;
          countdownActive = true;
          element.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÉ‡∏ô ${timeLeft}`;

          if (ExtendTime) {
            const msg = `‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°! ‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
            showAIMessage(msg);
          }

          clearInterval(interval); // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô
          interval = setInterval(() => {
            timeLeft--;
            if (timeLeft > 0) {
              element.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÉ‡∏ô ${timeLeft}`;

              if (timeLeft === 6) {
                showAIMessage("‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏∞");
                const audio = new Audio("./sounds/‡∏õ‡∏¥‡∏î.mp3"); // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î "‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏∞"
                audio.play();
              } else if (timeLeft === 3) {
                showAIMessage("3");
                const audio = new Audio("./sounds/3.mp3");
                audio.play();
              } else if (timeLeft === 2) {
                showAIMessage("2");
                const audio = new Audio("./sounds/2.mp3");
                audio.play();
              } else if (timeLeft === 1) {
                showAIMessage("1");
                const audio = new Audio("./sounds/1.mp3");
                audio.play();
              }
            } else {
              clearInterval(interval);
              countdownActive = false;
              if (!called) {
                called = true;
                closeAuction(); // ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
              }
            }
          }, 1000);
        }
        // üèÅ ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
        async function closeAuction() {
          element.textContent = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß";
          auctionEnded = true;        // ‚úÖ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ß‡πà‡∏≤‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß
          clearTimeout(idleTimer);    // ‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å idleTimer
          idleTimer = null;

          document.querySelectorAll(".btn-bid").forEach((btn) => {
            btn.disabled = true;
            btn.style.opacity = "0.5";
            btn.style.cursor = "not-allowed";
          });
          
          try {
            const token = localStorage.getItem("token");
            const payload = parseJwt(token); // token ‡∏Ç‡∏≠‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const res = await fetch(`/api/products/close/${productId}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                ...(token ? { Authorization: `Bearer ${token}` } : {}),
              },
            });
            const data = await res.json();

            console.log("DEBUG: closeAuction triggered", data);

            if (res.ok) {
              if (data.winner_user_id && data.final_price) {
                let winnerName = "";

                try {
                  const resHistory = await fetch(
                    `/api/bids/history?product_id=${productId}`
                  );
                  const history = await resHistory.json();

                  let winnerBid = history.find(
                    (bid) => Number(bid.bid_price) === Number(data.final_price)
                  );
                  if (!winnerBid && history.length > 0) {
                    winnerBid = history[0];
                  }
                  winnerName = winnerBid ? winnerBid.username : "";
                } catch (err) {
                  console.error("Error fetching bid history:", err);
                }

                if (winnerName) {
                  const winnerId = data.winner_user_id;
                  const finalPrice = data.final_price;

                  // ‚úÖ ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô AI ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
                  const prompt = `‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Å‡∏±‡∏ö ${winnerName} ‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ ${finalPrice} ‡∏ö‡∏≤‡∏ó!`;
                  fetchAIMessage(prompt, prompt, productId);

                  // ‚úÖ Popup ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞
                  if (payload && Number(payload.id) === Number(winnerId)) {
                    showWinnerPopup(
                      winnerName,
                      finalPrice,
                      `/confirm?winner=${winnerId}`
                    );
                  }
                }
              } else {
                const fallbackMsg = data.message || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•";
                fetchAIMessage(fallbackMsg, fallbackMsg, productId);
              }
            }else {
              const errMsg = data.message || "‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
              fetchAIMessage(errMsg, errMsg, productId);
            }
            if (data.token) localStorage.setItem("token", data.token);
          } catch (err) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•");
          }
        }

            // üîÑ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ bid ‡πÉ‡∏´‡∏°‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á soft close ‚Üí ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
            socket.on("auction endtime", ({ productId: pid, endTime, reason }) => {
          if (pid === productId && !called) {
            const now = Date.now();
            const secondsLeft = Math.max(0, Math.floor((endTime - now) / 1000));
            clearInterval(interval);

            const isExtend = reason === "bid";
            updateCountdown(secondsLeft, isExtend); // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á
          }
        });
          const endTime = new Date(endTimeStr).getTime();
          const now = Date.now();
          const initialSeconds = Math.max(0, Math.floor((endTime - now) / 1000));
          updateCountdown(initialSeconds);
      }

      function showWinnerPopup(winnerName, finalPrice, confirmUrl) {
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ popup ‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
        const existingPopup = document.querySelector(".popup-overlay");
        if (existingPopup) existingPopup.remove();

        const popup = document.createElement("div");
        popup.classList.add("popup-overlay");
        popup.innerHTML = `
          <div class="popup">
              <div class="popup-content">
                  <h2>üéâ ‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ ${winnerName}!</h2>
                  <p>‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ <b>${finalPrice} ‡∏ö‡∏≤‡∏ó</b></p>
                  <button id="goConfirmBtn">‡πÑ‡∏õ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</button>
              </div>
          </div>
      `;
        document.body.appendChild(popup);

        document
          .getElementById("goConfirmBtn")
          .addEventListener("click", () => {
            window.location.href = `confirm-product.html?id=${productId}`;
          });
      }

      function pad(n) {
        return n.toString().padStart(2, "0");
      }

      document.querySelectorAll(".quick-bid .btn-bid").forEach((btn) => {
        btn.addEventListener("click", () => {
          const bid = parseFloat(btn.dataset.bid);
          document.getElementById("customBid").value = bid; // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á
          document.getElementById("customBidBtn").click(); // ‡∏™‡πà‡∏á bid ‡πÄ‡∏•‡∏¢
        });
      });

      loadProductDetails();
      loadHighestBid(productId);
      updateQuickBidButtons(productId);
      loadBidHistory(productId);

      window.onload = async function () {
        try {
          const token = localStorage.getItem("token");

          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ token ‚Üí redirect ‡πÑ‡∏õ login
          if (!token) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
            window.location.href = "/login/login.html";
            return;
          }

          // ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î coin ‡∏à‡∏≤‡∏Å API
          const res = await fetch("/api/coins/balance", {
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î coin");
          }

          // ‡πÅ‡∏™‡∏î‡∏á coin balance ‡∏à‡∏≤‡∏Å server
          const coinSpan = document.getElementById("coinBalance");
          if (coinSpan) {
            coinSpan.textContent = Number(data.coin_balance).toFixed(2);
          }

          // ‡∏≠‡πà‡∏≤‡∏ô payload ‡∏à‡∏≤‡∏Å JWT
          const payload = parseJwt(token);

          if (payload && payload.username) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            const iconLink = document.querySelector(".personal-icon a");
            if (iconLink)
              iconLink.setAttribute("title", `‡∏Ñ‡∏∏‡∏ì ${payload.username}`);

            const nameSpan = document.getElementById("usernameDisplay");
            if (nameSpan) nameSpan.textContent = `‡∏Ñ‡∏∏‡∏ì ${payload.username}`;

            // ‡∏ñ‡πâ‡∏≤ role ‡πÄ‡∏õ‡πá‡∏ô seller ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (payload.role === "seller") {
              const addBtn = document.getElementById("addProductBtnContainer");
              if (addBtn) addBtn.style.display = "block";
            }
          } else {
            // token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚Üí ‡∏•‡∏ö token ‡πÅ‡∏•‡∏∞ redirect
            alert("Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            localStorage.removeItem("token");
            window.location.href = "/login/login.html";
            return;
          }

        } catch (err) {
          console.error("Error on window.onload:", err);
          alert(err.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
          // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ error ‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á ‡∏≠‡∏≤‡∏à redirect ‡πÑ‡∏õ login
          // window.location.href = '/login/login.html';
        }
      };

      // ====== Socket.IO Join Auction ======
      socket.on("connect", () => {
        const token = localStorage.getItem("token");
        if (!token) return;

        const payload = parseJwt(token);
        if (!payload) return;

        // join ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ
        socket.emit("join auction", {
          productId,
          userId: payload.id,
          username: payload.username,
        });
      });

      // ‡∏ü‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
      socket.on("participants update", (data) => {
        if (data.productId !== productId) return;

        const countEl = document.querySelector(".participant-count .count");
        const avatarsEl = document.querySelector(".avatars");

        // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô
        if (countEl) {
          countEl.innerText = data.participants.length;
        }

        // ‡πÅ‡∏™‡∏î‡∏á avatar (‡∏à‡∏≥‡∏Å‡∏±‡∏î 5 ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å + more)
        if (avatarsEl) {
          avatarsEl.innerHTML = "";
          data.participants.slice(0, 5).forEach((p, i) => {
            avatarsEl.innerHTML += `
              <div class="avatar">
                <img src="https://i.pravatar.cc/24?img=${i+1}" />
                <span class="tooltip">${p.username}</span>
              </div>
            `;
          });
          if (data.participants.length > 5) {
            avatarsEl.innerHTML += `<span class="more" title="${data.participants.slice(5).map(p => p.username).join(', ')}">+${data.participants.length - 5}</span>`;
          }

        }
      });


      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô parseJwt
      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map(function (c) {
                return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
              })
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
      }
    </script>
  </body>
</html>

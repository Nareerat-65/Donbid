<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</title>
    <link rel="stylesheet" href="purchaseCoins-styles.css">
    <link href='https://fonts.googleapis.com/css?family=Kanit&subset=thai,latin' rel='stylesheet' type='text/css'>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <nav name="navbar" class="navbar">
      <div>
        <a href="../content/main-and-login.html" class="logo-link">
          <img src="../pic/Logo2.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="logo" />
        </a>
      </div>

      <div class="personal-icon">
        <a href="../content/profile-check.html" class="logo-link">
          <img src="../pic/personal-icon.png" alt="‡πÑ‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô" class="personal-icon" />
        </a>
        <span id="usernameDisplay"></span>
      </div>

      <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Seller -->
      <div
        id="addProductBtnContainer"
        style="text-align: right; padding: 10px; display: none"
      >
        <button
          onclick="location.href='/seller/add-product.html'"
          style="
            padding: 10px 20px;
            background-color: #FAF5E6;
            color: black;
            border: none;
            border-radius: 5px;
            cursor: pointer;
          "
        >
          + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </button>
      </div>
    </nav>

    <div class="content">
        <h1>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå</h1>
        <h2>üí∞ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå: <span id="coinBalance">0.00</span></h2>
        <!-- Repeat this process for each package you want to add -->
        <div class="packages">
            <div class="package">
                <h3>Starter</h3>
                <div class="coins">300 ‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå</div>
                <div class="price">300 ‡∏ö‡∏≤‡∏ó</div>
                <button class="btn" onclick="openPopup('Starter', 300)">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
            <div class="package">
                <h3>Basic</h3>
                <div class="coins">500 ‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå</div>
                <div class="price">500 ‡∏ö‡∏≤‡∏ó</div>
                <button class="btn" onclick="openPopup('Basic', 500)">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
            <div class="package">
                <h3>Standard</h3>
                <div class="coins">700 ‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå</div>
                <div class="price">700 ‡∏ö‡∏≤‡∏ó</div>
                <button class="btn" onclick="openPopup('Standard', 700)">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
            <div class="package">
                <h3>Pro</h3>
                <div class="coins">900 ‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå</div>
                <div class="price">900 ‡∏ö‡∏≤‡∏ó</div>
                <button class="btn" onclick="openPopup('Pro', 900)">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
            <div class="package">
                <h3>Premium</h3>
                <div class="coins">1,000 ‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå</div>
                <div class="price">1,000 ‡∏ö‡∏≤‡∏ó</div>
                <button class="btn" onclick="openPopup('Premium', 1000)">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
            <div class="package">
                <h3>Ultimate</h3>
                <div class="coins">1,300 ‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå</div>
                <div class="price">1,300 ‡∏ö‡∏≤‡∏ó</div>
                <button class="btn" onclick="openPopup('Ultimate', 1300)">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
        </div>
    </div>
    <div class="overlay" id="paymentPopup">
        <div class="popup">
            <div class="close-btn" onclick="closePopup()">√ó</div>
            <h2>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
            <p>‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à: <span id="popupPackage"></span></p>
            <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: <span id="popupAmount"></span> ‡∏ö‡∏≤‡∏ó</p>

            <div class="payment-methods">
                <button>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</button>
                <button>TrueMoney</button>
                <button>PromptPay</button>
                <button>PayPal</button>
            </div>

            <div class="payment-summary">
                <p>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: <b id="popupTotal"></b> ‡∏ö‡∏≤‡∏ó</p>
                <p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î ‚Äú‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‚Äù ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            </div>

            <button class="confirm-btn" onclick="confirmPayment()">‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>
    </div>
    <script>
        function showAlertError(title, message, icon = "error") {
            Swal.fire({
                icon: icon,
                title: title,
                text: message,
                confirmButtonColor: "#3085d6",
                confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
            });
        }
        function showAlert(title, message, icon = "success") {
            Swal.fire({
                icon: icon,
                title: title,
                text: message,
                confirmButtonColor: "#3085d6",
                confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
            });
        }


        // üÜï ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        let selectedAmount = 0;

        // üÜï ‡πÄ‡∏õ‡∏¥‡∏î popup ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function openPopup(packageName, amount) {
            selectedAmount = amount;
            document.getElementById('popupPackage').textContent = packageName;
            document.getElementById('popupAmount').textContent = amount.toFixed(2);
            document.getElementById('popupTotal').textContent = amount.toFixed(2);
            document.getElementById('paymentPopup').style.display = 'flex';
        }

        // üÜï ‡∏õ‡∏¥‡∏î popup
        function closePopup() {
            document.getElementById('paymentPopup').style.display = 'none';
        }
        async function selectPackage(amount) {
            const token = localStorage.getItem('token');
            if (!token) {
                showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô");
                return;
            }

            try {
                const res = await fetch('/api/coins/topup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ amount })
                });

                const data = await res.json();

                if (res.ok) {
                    if (data.token) {
                        localStorage.setItem('token', data.token); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï token ‡πÉ‡∏´‡∏°‡πà
                    }

                    showAlert("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà: ${Number(data.coin_balance).toFixed(2)} ‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå`);
                    document.getElementById('coinBalance').textContent = Number(data.coin_balance).toFixed(2);

                } else {
                    showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
            } catch (err) {
                console.error(err);
                showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
            }
        }

        async function confirmPayment() {
            const token = localStorage.getItem('token');
            if (!token) {
                showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô");
                return;
            }

            try {
                const res = await fetch('/api/coins/topup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ amount: selectedAmount })
                });

                const data = await res.json();

                if (res.ok) {
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                    }

                    showAlert("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà: ${Number(data.coin_balance).toFixed(2)} ‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå`);
                    document.getElementById('coinBalance').textContent = Number(data.coin_balance).toFixed(2);
                    closePopup(); // üÜï ‡∏õ‡∏¥‡∏î popup ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                } else {
                    showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
            } catch (err) {
                console.error(err);
                showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
            }
        }

        function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
      }

        window.addEventListener("load", async () => {
            try {
                const token = localStorage.getItem("token");
                if (!token) return;

                // ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î coin
                const res = await fetch("/api/coins/balance", {
                    headers: { Authorization: `Bearer ${token}` },
                });
                const data = await res.json();
                document.getElementById("coinBalance").textContent = Number(data.coin_balance).toFixed(2);

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                const payload = parseJwt(token);
                if (payload && payload.username) {
                    const nameSpan = document.getElementById("usernameDisplay");
                    if (nameSpan) nameSpan.textContent = `‡∏Ñ‡∏∏‡∏ì ${payload.username}`;

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° seller
                    if (payload.role === "seller") {
                        const addBtn = document.getElementById("addProductBtnContainer");
                        if (addBtn) addBtn.style.display = "block";
                    }
                }
            } catch (err) {
                console.error(err);
            }
        });
    </script>

</body>

</html>
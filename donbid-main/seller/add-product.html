<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
    <link rel="stylesheet" href="add-product-style.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Kanit&subset=thai,latin"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body>
    <nav name="navbar" class="navbar">
      <div>
        <a href="../content/main-and-login.html" class="logo-link">
          <img src="../pic/Logo.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="logo" />
        </a>
      </div>
      <div class="coin-icon">
        <h1>coin</h1>
      </div>
      <div class="personal-icon">
        <a href="../content/profile-check.html" class="logo-link">
          <img
            src="../pic/personal-icon.png"
            alt="‡πÑ‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô"
            class="personal-icon"
          />
        </a>
        <span
          id="usernameDisplay"
          style="margin-left: 10px; font-weight: bold"
        ></span>
      </div>

      <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Seller -->
      <div
        id="addProductBtnContainer"
        style="text-align: right; padding: 10px; display: none"
      >
        <button
          onclick="location.href='/seller/add-product.html'"
          style="
            padding: 10px 20px;
            background-color: #ff9900;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
          "
        >
          + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </button>
      </div>
    </nav>

    <form id="addProductForm" enctype="multipart/form-data" method="POST">
      <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>

      <div id="calendar"></div>
      <input type="hidden" id="start_time" name="start_time" />
      <input type="hidden" id="end_time" name="end_time" />

      <label
        >‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:
        <input type="text" name="name" required />
      </label>
      <label for="category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
      <select id="category" name="category" required>
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
        <option value="character_model">‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</option>
        <option value="doll">‡∏ï‡∏∏‡πä‡∏Å‡∏ï‡∏≤</option>
        <option value="card_game">‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏Å‡∏°</option>
        <option value="other">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>

      <label
        >‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:
        <textarea name="description" required></textarea>
      </label>

      <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
      <input
        type="file"
        id="file-input"
        name="images"
        accept="image/*"
        multiple
        required
      />
      <div id="preview" style="margin-top: 10px"></div>

      <label
        >‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:
        <input type="number" name="start_price" step="0.01" required />
      </label>

      <!-- <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•:
      <input type="datetime-local" name="start_time" required>
    </label>

    <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•:
      <input type="datetime-local" name="end_time" required>
    </label> -->

      <button type="submit">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    </form>

    <script>
      function showAlertError(title, message, icon = "error") {
            Swal.fire({
                icon: icon,
                title: title,
                text: message,
                confirmButtonColor: "#3085d6",
                confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
            });
        }

        function showAlert(title, message, icon = "success") {
        Swal.fire({
            icon: icon,
            title: title,
            text: message,
            confirmButtonColor: "#3085d6",
            confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
        });
    }

      const token = localStorage.getItem("token");

      if (!token) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
        window.location.href = "/login/login.html";
      }

      document.addEventListener("DOMContentLoaded", async function () {
        const calendarEl = document.getElementById("calendar");
        const startInput = document.getElementById("start_time");
        const endInput = document.getElementById("end_time");

        const res = await fetch("/api/products");
        let products = await res.json();

        // ‡∏î‡∏∂‡∏á seller_username ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        async function enrichProductsWithSeller(products) {
          return await Promise.all(
            products.map(async (p) => {
              if (!p.seller_username) {
                try {
                  const res = await fetch(`/api/products/${p.id}`);
                  const detail = await res.json();
                  p.seller_username = detail.seller_username || "-";
                } catch (err) {
                  p.seller_username = "-";
                }
              }
              return p;
            })
          );
        }
        products = await enrichProductsWithSeller(products);

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏á event
        const events = products.map((p) => ({
          id: p.id,
          title: p.name,
          start: p.start_time,
          end: p.end_time,
          color: "#ff9900",
          extendedProps: {
            description: p.description,
            category: p.category,
            start_price: p.start_price,
            seller: p.seller_username || "-",
          },
        }));

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          selectable: true,
          selectMirror: true,
          locale: "th",
          height: 700, // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
          contentHeight: 700,
          aspectRatio: 1.7, // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay",
          },
          events: events,

          dateClick: function (info) {
            const today = new Date();
            const clickedDate = new Date(info.dateStr);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
            if (clickedDate.setHours(0, 0, 0, 0) < today.setHours(0, 0, 0, 0)) {
              showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï");
              return;
            }

            // ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const newEvents = calendar
              .getEvents()
              .filter((ev) => ev.extendedProps.type === "new");
            if (newEvents.length > 0) {
              showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
              return;
            }

            // ‡πÅ‡∏™‡∏î‡∏á modal ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡∏™‡∏£‡πâ‡∏≤‡∏á modal dynamic)
            const modalHtml = `
        <div id="timeModal" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
          background:white; padding:20px; border:1px solid #ccc; z-index:1000;">
          <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h3>
          <label>‡πÄ‡∏£‡∏¥‡πà‡∏°: <input type="time" id="modalStartTime" required></label>
          <label>(!) ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô </label>
          <br><br>
          <button id="saveTimeBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button id="cancelTimeBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
        <div id="modalOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%;
          background:rgba(0,0,0,0.5); z-index:999;"></div>
      `;
            document.body.insertAdjacentHTML("beforeend", modalHtml);

            const saveBtn = document.getElementById("saveTimeBtn");
            const cancelBtn = document.getElementById("cancelTimeBtn");
            const modal = document.getElementById("timeModal");
            const overlay = document.getElementById("modalOverlay");

            saveBtn.onclick = function () {
              const startTime = document.getElementById("modalStartTime").value;
              <!-- const endTime = document.getElementById("modalEndTime").value; -->

              function formatLocal(date) {
                const pad = (n) => (n < 10 ? "0" + n : n);
                return (
                  date.getFullYear() +
                  "-" +
                  pad(date.getMonth() + 1) +
                  "-" +
                  pad(date.getDate()) +
                  " " +
                  pad(date.getHours()) +
                  ":" +
                  pad(date.getMinutes()) +
                  ":" +
                  pad(date.getSeconds())
                );
              }

              if (!startTime) {
                showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
                return;
              }

              const startDateTime = new Date(info.dateStr + "T" + startTime);
              const endDateTime = new Date(startDateTime.getTime() + 60 * 60 * 1000); // ‡∏ö‡∏ß‡∏Å 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á

              const now = new Date();

              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
              if (startDateTime < now) {
                showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ");
                return;
              }

              // ‡πÄ‡∏ä‡πá‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô event ‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
              const startHour = startDateTime.getHours();
              const day = startDateTime.toISOString().split("T")[0];
              const eventsInHour = calendar.getEvents().filter((ev) => {
                const evStart = new Date(ev.start);
                return (
                  evStart.getHours() === startHour &&
                  evStart.toISOString().split("T")[0] === day
                );
              });

              if (eventsInHour.length >= 5) {
                showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
                return;
              }

              // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á input form
              startInput.value = formatLocal(startDateTime);
              endInput.value = formatLocal(endDateTime);

              // ‡∏™‡∏£‡πâ‡∏≤‡∏á event ‡∏ö‡∏ô calendar
              calendar.addEvent({
                title: "üõí ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà",
                start: startDateTime,
                end: endDateTime,
                allDay: false,
                extendedProps: { type: "new" },
              });

              showAlert(
                "üìÖ ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:",
                `‡πÄ‡∏£‡∏¥‡πà‡∏°: ${startDateTime.toLocaleString()}\n‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ${endDateTime.toLocaleString()}`
              );

              // ‡∏õ‡∏¥‡∏î modal
              modal.remove();
              overlay.remove();
            };

            cancelBtn.onclick = function () {
              modal.remove();
              overlay.remove();
            };
          },

          eventMouseEnter: function(info) {
            const props = info.event.extendedProps;
            const tooltip = document.createElement("div");
            tooltip.className = "fc-tooltip";
            tooltip.innerHTML = `
              <b>${info.event.title}</b><br>
              ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${props.category || "-"}<br>
              ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ${props.start_price || "-"}<br>
              ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢: ${props.seller || "-"}<br>
              ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${props.description || "-"}
            `;
            document.body.appendChild(tooltip);

            function positionTooltip(e) {
              tooltip.style.left = (e.pageX + 16) + "px";
              tooltip.style.top = (e.pageY + 16) + "px";
            }
            positionTooltip(info.jsEvent);

            info.el.addEventListener("mousemove", positionTooltip);
            info.el._fcTooltip = tooltip;
          },
          eventMouseLeave: function(info) {
            if (info.el._fcTooltip) {
              info.el._fcTooltip.remove();
              info.el._fcTooltip = null;
            }
          },
        });

        calendar.render();
      });

      document
        .getElementById("file-input")
        .addEventListener("change", function (event) {
          const preview = document.getElementById("preview");
          preview.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á preview ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

          const files = event.target.files;
          if (!files) return;

          Array.from(files).forEach((file) => {
            if (!file.type.startsWith("image/")) return; // ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û

            const img = document.createElement("img");
            img.alt = file.name;

            const reader = new FileReader();
            reader.onload = (e) => {
              img.src = e.target.result;
            };
            reader.readAsDataURL(file);

            preview.appendChild(img);
          });
        });

      document
        .getElementById("addProductForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const formData = new FormData(form);

          const res = await fetch("/api/products", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const result = await res.json();

          if (res.ok) {
            showAlert("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            window.location.href = "/content/main-and-login.html"; // ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ seller dashboard
          } else {
            showAlertError("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", result.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
          }
        });
    </script>
  </body>
</html>


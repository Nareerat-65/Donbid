<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
    <link rel="stylesheet" href="add-product-style.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Kanit&subset=thai,latin"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  </head>

  <body>
    <nav name="navbar" class="navbar">
      <div>
        <a href="../content/main-and-login.html" class="logo-link">
          <img src="../pic/Logo.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" class="logo" />
        </a>
      </div>
      <div class="coin-icon">
        <h1>coin</h1>
      </div>
      <div class="personal-icon">
        <a href="../content/profile-check.html" class="logo-link">
          <img
            src="../pic/personal-icon.png"
            alt="‡πÑ‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô"
            class="personal-icon"
          />
        </a>
        <span
          id="usernameDisplay"
          style="margin-left: 10px; font-weight: bold"
        ></span>
      </div>

      <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Seller -->
      <div
        id="addProductBtnContainer"
        style="text-align: right; padding: 10px; display: none"
      >
        <button
          onclick="location.href='/seller/add-product.html'"
          style="
            padding: 10px 20px;
            background-color: #ff9900;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
          "
        >
          + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </button>
      </div>
    </nav>

    <form id="addProductForm" enctype="multipart/form-data" method="POST">
      <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>

      <div id="calendar"></div>
      <input type="hidden" id="start_time" name="start_time" />
      <input type="hidden" id="end_time" name="end_time" />

      <label
        >‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:
        <input type="text" name="name" required />
      </label>
      <label for="category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
      <select id="category" name="category" required>
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
        <option value="character_model">‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</option>
        <option value="doll">‡∏ï‡∏∏‡πä‡∏Å‡∏ï‡∏≤</option>
        <option value="card_game">‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏Å‡∏°</option>
        <option value="other">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>

      <label
        >‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:
        <textarea name="description" required></textarea>
      </label>

      <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
      <input
        type="file"
        id="file-input"
        name="images"
        accept="image/*"
        multiple
        required
      />
      <div id="preview" style="margin-top: 10px"></div>

      <label
        >‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:
        <input type="number" name="start_price" step="0.01" required />
      </label>

      <!-- <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•:
      <input type="datetime-local" name="start_time" required>
    </label>

    <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•:
      <input type="datetime-local" name="end_time" required>
    </label> -->

      <button type="submit">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    </form>

    <script>
      const token = localStorage.getItem("token");

      if (!token) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
        window.location.href = "/login/login.html";
      }

      document.addEventListener("DOMContentLoaded", async function () {
        const calendarEl = document.getElementById("calendar");

        const res = await fetch("/api/products");
        const products = await res.json();

        const events = products.map((p) => ({
          id: p.id,
          title: p.name,
          start: p.start_time,
          end: p.end_time,
          color: "#ff9900", // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ event ‡πÑ‡∏î‡πâ
        }));

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth", // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
          selectable: true, // ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ
          locale: "th",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay",
          },
          events: events,

          dateClick: function (info) {
            // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‚Üí ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ timeGridDay ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
            calendar.changeView("timeGridDay", info.dateStr);
          },

          select: function (info) {
            const startInput = document.getElementById("start_time");
            const endInput = document.getElementById("end_time");

            const existingEvents = calendar.getEvents();
            if (existingEvents.length > 0) {
              alert("‚ùå ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
              return; // ‡∏´‡∏¢‡∏∏‡∏î ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°
            }

            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå) ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤
            startInput.value = info.startStr;
            endInput.value = info.endStr;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô
            const startHour = new Date(info.start).getHours();
            const day = new Date(info.start).toISOString().split("T")[0];

            const eventsInHour = calendar.getEvents().filter((ev) => {
              const evStart = new Date(ev.start);
              return (
                evStart.getHours() === startHour &&
                evStart.toISOString().split("T")[0] === day
              );
            });

            if (eventsInHour.length >= 5) {
              alert("‚ùå ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
              return; // ‚ùó ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á event ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô calendar
            calendar.addEvent({
              title: "üõí ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà",
              start: info.startStr,
              end: info.endStr,
              allDay: info.allDay,
            });

            alert(
              `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:\n‡πÄ‡∏£‡∏¥‡πà‡∏°: ${info.startStr}\n‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ${info.endStr}`
            );
          },
        });

        calendar.render();
      });

      document
        .getElementById("file-input")
        .addEventListener("change", function (event) {
          const preview = document.getElementById("preview");
          preview.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á preview ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

          const files = event.target.files;
          if (!files) return;

          Array.from(files).forEach((file) => {
            if (!file.type.startsWith("image/")) return; // ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û

            const img = document.createElement("img");
            img.alt = file.name;

            const reader = new FileReader();
            reader.onload = (e) => {
              img.src = e.target.result;
            };
            reader.readAsDataURL(file);

            preview.appendChild(img);
          });
        });

      document
        .getElementById("addProductForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const formData = new FormData(form);

          const res = await fetch("/api/products", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const result = await res.json();

          if (res.ok) {
            alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            window.location.href = "/content/main-and-login.html"; // ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ seller dashboard
          } else {
            alert(result.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
          }
        });
    </script>
  </body>
</html>

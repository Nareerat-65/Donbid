<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>เพิ่มสินค้า</title>
    <link rel="stylesheet" href="add-product-style.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Kanit&subset=thai,latin"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body>
    <nav name="navbar" class="navbar">
      <div>
        <a href="../content/main-and-login.html" class="logo-link">
          <img src="../pic/Logo.png" alt="โลโก้" class="logo" />
        </a>
      </div>
      <div class="coin-icon">
        <h1>coin</h1>
      </div>
      <div class="personal-icon">
        <a href="../content/profile-check.html" class="logo-link">
          <img
            src="../pic/personal-icon.png"
            alt="ไอค่อน"
            class="personal-icon"
          />
        </a>
        <span
          id="usernameDisplay"
          style="margin-left: 10px; font-weight: bold"
        ></span>
      </div>

      <!-- เพิ่มสินค้าเฉพาะ Seller -->
      <div
        id="addProductBtnContainer"
        style="text-align: right; padding: 10px; display: none"
      >
        <button
          onclick="location.href='/seller/add-product.html'"
          style="
            padding: 10px 20px;
            background-color: #ff9900;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
          "
        >
          + เพิ่มสินค้า
        </button>
      </div>
    </nav>

    <form id="addProductForm" enctype="multipart/form-data" method="POST">
      <h2>เพิ่มสินค้าใหม่</h2>

      <div id="calendar"></div>
      <input type="hidden" id="start_time" name="start_time" />
      <input type="hidden" id="end_time" name="end_time" />

      <label
        >ชื่อสินค้า:
        <input type="text" name="name" required />
      </label>
      <label for="category">หมวดหมู่:</label>
      <select id="category" name="category" required>
        <option value="">เลือกหมวดหมู่สินค้า</option>
        <option value="character_model">โมเดลตัวละคร</option>
        <option value="doll">ตุ๊กตา</option>
        <option value="card_game">การ์ดเกม</option>
        <option value="other">อื่น ๆ</option>
      </select>

      <label
        >รายละเอียดสินค้า:
        <textarea name="description" required></textarea>
      </label>

      <label>รูปภาพสินค้า:</label>
      <input
        type="file"
        id="file-input"
        name="images"
        accept="image/*"
        multiple
        required
      />
      <div id="preview" style="margin-top: 10px"></div>

      <label
        >ราคาเริ่มต้น:
        <input type="number" name="start_price" step="0.01" required />
      </label>

      <!-- <label>เวลาที่เริ่มประมูล:
      <input type="datetime-local" name="start_time" required>
    </label>

    <label>เวลาที่สิ้นสุดประมูล:
      <input type="datetime-local" name="end_time" required>
    </label> -->

      <button type="submit">เพิ่มสินค้า</button>
    </form>

    <script>
      function showAlertError(title, message, icon = "error") {
            Swal.fire({
                icon: icon,
                title: title,
                text: message,
                confirmButtonColor: "#3085d6",
                confirmButtonText: "ตกลง",
            });
        }

        function showAlert(title, message, icon = "success") {
        Swal.fire({
            icon: icon,
            title: title,
            text: message,
            confirmButtonColor: "#3085d6",
            confirmButtonText: "ตกลง",
        });
    }

      const token = localStorage.getItem("token");

      if (!token) {
        alert("กรุณาเข้าสู่ระบบ");
        window.location.href = "/login/login.html";
      }

      document.addEventListener("DOMContentLoaded", async function () {
        const calendarEl = document.getElementById("calendar");
        const startInput = document.getElementById("start_time");
        const endInput = document.getElementById("end_time");

        const res = await fetch("/api/products");
        let products = await res.json();

        // ดึง seller_username สำหรับแต่ละสินค้า
        async function enrichProductsWithSeller(products) {
          return await Promise.all(
            products.map(async (p) => {
              if (!p.seller_username) {
                try {
                  const res = await fetch(`/api/products/${p.id}`);
                  const detail = await res.json();
                  p.seller_username = detail.seller_username || "-";
                } catch (err) {
                  p.seller_username = "-";
                }
              }
              return p;
            })
          );
        }
        products = await enrichProductsWithSeller(products);

        // เพิ่มรายละเอียดลง event
        const events = products.map((p) => ({
          id: p.id,
          title: p.name,
          start: p.start_time,
          end: p.end_time,
          color: "#ff9900",
          extendedProps: {
            description: p.description,
            category: p.category,
            start_price: p.start_price,
            seller: p.seller_username || "-",
          },
        }));

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          selectable: true,
          selectMirror: true,
          locale: "th",
          height: 700, // ขยายความสูง
          contentHeight: 700,
          aspectRatio: 1.7, // ขยายความกว้าง
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay",
          },
          events: events,

          dateClick: function (info) {
            const today = new Date();
            const clickedDate = new Date(info.dateStr);

            // ตรวจสอบวันย้อนหลัง
            if (clickedDate.setHours(0, 0, 0, 0) < today.setHours(0, 0, 0, 0)) {
              showAlertError("❌ ข้อผิดพลาด", "กรุณาเลือกวันในอนาคต");
              return;
            }

            // เช็กว่ามีการเลือกครั้งเดียวต่อสินค้าแล้วหรือยัง
            const newEvents = calendar
              .getEvents()
              .filter((ev) => ev.extendedProps.type === "new");
            if (newEvents.length > 0) {
              showAlertError("❌ ข้อผิดพลาด", "สามารถเลือกช่วงเวลาได้แค่ครั้งเดียวต่อสินค้า");
              return;
            }

            // แสดง modal ให้เลือกชั่วโมง (สร้าง modal dynamic)
            const modalHtml = `
        <div id="timeModal" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
          background:white; padding:20px; border:1px solid #ccc; z-index:1000;">
          <h3>เลือกช่วงเวลา</h3>
          <label>เริ่ม: <input type="time" id="modalStartTime" required></label>
          <label>(!) เวลาสิ้นสุดจะเป็น 1 ชั่วโมงหลังจากเวลาเริ่มต้น </label>
          <br><br>
          <button id="saveTimeBtn">บันทึก</button>
          <button id="cancelTimeBtn">ยกเลิก</button>
        </div>
        <div id="modalOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%;
          background:rgba(0,0,0,0.5); z-index:999;"></div>
      `;
            document.body.insertAdjacentHTML("beforeend", modalHtml);

            const saveBtn = document.getElementById("saveTimeBtn");
            const cancelBtn = document.getElementById("cancelTimeBtn");
            const modal = document.getElementById("timeModal");
            const overlay = document.getElementById("modalOverlay");

            saveBtn.onclick = function () {
              const startTime = document.getElementById("modalStartTime").value;
              <!-- const endTime = document.getElementById("modalEndTime").value; -->

              function formatLocal(date) {
                const pad = (n) => (n < 10 ? "0" + n : n);
                return (
                  date.getFullYear() +
                  "-" +
                  pad(date.getMonth() + 1) +
                  "-" +
                  pad(date.getDate()) +
                  " " +
                  pad(date.getHours()) +
                  ":" +
                  pad(date.getMinutes()) +
                  ":" +
                  pad(date.getSeconds())
                );
              }

              if (!startTime) {
                showAlertError("❌ ข้อผิดพลาด", "กรุณาเลือกเวลาให้ครบ");
                return;
              }

              const startDateTime = new Date(info.dateStr + "T" + startTime);
              const endDateTime = new Date(startDateTime.getTime() + 60 * 60 * 1000); // บวก 1 ชั่วโมง

              const now = new Date();

              // ตรวจสอบเวลาย้อนหลัง
              if (startDateTime < now) {
                showAlertError("❌ ข้อผิดพลาด", "ไม่สามารถเลือกเวลาที่ผ่านมาแล้วหรือสิ้นสุดก่อนเริ่มได้");
                return;
              }

              // เช็กจำนวน event ต่อชั่วโมง
              const startHour = startDateTime.getHours();
              const day = startDateTime.toISOString().split("T")[0];
              const eventsInHour = calendar.getEvents().filter((ev) => {
                const evStart = new Date(ev.start);
                return (
                  evStart.getHours() === startHour &&
                  evStart.toISOString().split("T")[0] === day
                );
              });

              if (eventsInHour.length >= 5) {
                showAlertError("❌ ข้อผิดพลาด", "จำกัดชั่วโมงละไม่เกิน 5 สินค้า");
                return;
              }

              // บันทึกลง input form
              startInput.value = formatLocal(startDateTime);
              endInput.value = formatLocal(endDateTime);

              // สร้าง event บน calendar
              calendar.addEvent({
                title: "🛒 สินค้าใหม่",
                start: startDateTime,
                end: endDateTime,
                allDay: false,
                extendedProps: { type: "new" },
              });

              showAlert(
                "📅 คุณเลือกช่วงเวลา:",
                `เริ่ม: ${startDateTime.toLocaleString()}\nสิ้นสุด: ${endDateTime.toLocaleString()}`
              );

              // ปิด modal
              modal.remove();
              overlay.remove();
            };

            cancelBtn.onclick = function () {
              modal.remove();
              overlay.remove();
            };
          },

          eventMouseEnter: function(info) {
            const props = info.event.extendedProps;
            const tooltip = document.createElement("div");
            tooltip.className = "fc-tooltip";
            tooltip.innerHTML = `
              <b>${info.event.title}</b><br>
              หมวดหมู่: ${props.category || "-"}<br>
              ราคาเริ่มต้น: ${props.start_price || "-"}<br>
              ผู้ขาย: ${props.seller || "-"}<br>
              รายละเอียด: ${props.description || "-"}
            `;
            document.body.appendChild(tooltip);

            function positionTooltip(e) {
              tooltip.style.left = (e.pageX + 16) + "px";
              tooltip.style.top = (e.pageY + 16) + "px";
            }
            positionTooltip(info.jsEvent);

            info.el.addEventListener("mousemove", positionTooltip);
            info.el._fcTooltip = tooltip;
          },
          eventMouseLeave: function(info) {
            if (info.el._fcTooltip) {
              info.el._fcTooltip.remove();
              info.el._fcTooltip = null;
            }
          },
        });

        calendar.render();
      });

      document
        .getElementById("file-input")
        .addEventListener("change", function (event) {
          const preview = document.getElementById("preview");
          preview.innerHTML = ""; // ล้าง preview เก่าทั้งหมด

          const files = event.target.files;
          if (!files) return;

          Array.from(files).forEach((file) => {
            if (!file.type.startsWith("image/")) return; // ตรวจเฉพาะไฟล์ภาพ

            const img = document.createElement("img");
            img.alt = file.name;

            const reader = new FileReader();
            reader.onload = (e) => {
              img.src = e.target.result;
            };
            reader.readAsDataURL(file);

            preview.appendChild(img);
          });
        });

      document
        .getElementById("addProductForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const formData = new FormData(form);

          const res = await fetch("/api/products", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const result = await res.json();

          if (res.ok) {
            showAlert("✅ สำเร็จ", "เพิ่มสินค้าสำเร็จ!");
            window.location.href = "/content/main-and-login.html"; // หรือหน้า seller dashboard
          } else {
            showAlertError("❌ ข้อผิดพลาด", result.message || "เกิดข้อผิดพลาด");
          }
        });
    </script>
  </body>
</html>

